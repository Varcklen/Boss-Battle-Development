{
  "Id": 50333220,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope BardW initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A1AV'\r\n        private constant integer ID_ABILITY_BUFF = 'B09N'\r\n        \r\n        private constant integer AREA = 500\r\n        private constant integer DURATION = 15\r\n        private constant integer TICK = 3\r\n        \r\n        \r\n        private constant integer ID_DAMAGE_REDUCTION = 'A1AZ'\r\n        private constant integer ID_DAMAGE_REDUCTION_ALTERNATIVE = 'A1C8'\r\n        private constant integer EFFECT_DAMAGE = 'A1AX'\r\n        private constant integer BUFF_DAMAGE = 'B09M'\r\n        \r\n        private constant integer DAMAGE_FIRST_LEVEL = 15\r\n        private constant integer DAMAGE_LEVEL_BONUS = 15\r\n        private constant integer STUN_DURATION = 1\r\n        \r\n        \r\n        private constant integer ID_DAMAGE_BUFF = 'A1AY'\r\n        private constant integer ID_DAMAGE_BUFF_ALTERNATIVE = 'A1C9'\r\n        private constant integer EFFECT_HEAL = 'A1AW'\r\n        private constant integer BUFF_HEAL = 'B09L'\r\n        \r\n        private constant integer HEAL_FIRST_LEVEL = 15\r\n        private constant integer HEAL_LEVEL_BONUS = 15\r\n        \r\n        private group TempGroup = null\r\n    endglobals\r\n\r\n    function Trig_BardW_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel(GetOrderedUnit(), ID_ABILITY) > 0 and (GetIssuedOrderId() == OrderId(\"immolation\") or GetIssuedOrderId() == OrderId(\"unimmolation\"))\r\n    endfunction\r\n\r\n    function BardWSorrowCast takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local real dmg = LoadReal( udg_hash, id, StringHash( \"barw\" ) )\r\n        local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"barw\" ) )\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"barwc\" ) )\r\n        \r\n        if IsUnitAlive(target) and GetUnitAbilityLevel( target, EFFECT_DAMAGE) > 0 then\r\n            set IsDisableSpellPower = true\r\n            call UnitTakeDamage(caster, target, dmg, DAMAGE_TYPE_MAGIC)\r\n        else\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        endif\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n\r\n    function BardWJoyCast takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local real heal = LoadReal( udg_hash, id, StringHash( \"barwj\" ) )\r\n        local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"barwj\" ) )\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"barwjd\" ) )\r\n\r\n        if IsUnitAlive(target) and GetUnitAbilityLevel( target, EFFECT_HEAL) > 0 then\r\n            call healst( caster, target, heal )\r\n        else\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        endif\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function DeleteBuffToAffected takes unit caster, boolean isBuff returns group\r\n        local unit u\r\n    \r\n        set TempGroup = LoadGroupHandle(udg_hash, GetHandleId(caster), StringHash( \"barwg\" ) )\r\n        \r\n        if TempGroup == null then\r\n            set TempGroup = CreateGroup()\r\n            call SaveGroupHandle(udg_hash, GetHandleId(caster), StringHash( \"barwg\" ), TempGroup )\r\n        endif\r\n        \r\n        loop\r\n            set u = FirstOfGroup(TempGroup)\r\n            exitwhen u == null\r\n            if isBuff then\r\n                call RemoveEffect(u, EFFECT_HEAL, BUFF_HEAL)\r\n                call UnitRemoveAbility(u, ID_DAMAGE_BUFF)\r\n                call UnitRemoveAbility(u, ID_DAMAGE_BUFF_ALTERNATIVE)\r\n            else\r\n                call RemoveEffect(u, EFFECT_DAMAGE, BUFF_DAMAGE)\r\n                call UnitRemoveAbility(u, ID_DAMAGE_REDUCTION)\r\n                call UnitRemoveAbility(u, ID_DAMAGE_REDUCTION_ALTERNATIVE)\r\n            endif\r\n            call GroupRemoveUnit(TempGroup,u)\r\n        endloop\r\n        \r\n        set caster = null\r\n        set u = null\r\n        return TempGroup\r\n    endfunction\r\n    \r\n    private function Heal_Alternative takes unit caster, integer level, real duration returns nothing \r\n        local group g = CreateGroup()\r\n        local unit n\r\n        local group affected = DeleteBuffToAffected(caster, false)\r\n        \r\n        call GroupEnumUnitsInRange( g, GetUnitX( caster ), GetUnitY( caster ), AREA, null )\r\n        loop\r\n            set n = FirstOfGroup(g)\r\n            exitwhen n == null\r\n            if unitst( n, caster, \"ally\" ) then\r\n                call bufallst( caster, n, EFFECT_HEAL, ID_DAMAGE_BUFF_ALTERNATIVE, 0, 0, 0, BUFF_HEAL, \"brdwj\", duration )\r\n                call SetUnitAbilityLevel( n, ID_DAMAGE_BUFF_ALTERNATIVE, level )\r\n                call GroupAddUnit(affected,n)\r\n            endif\r\n            call GroupRemoveUnit(g,n)\r\n        endloop\r\n        \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set n = null\r\n        set g = null\r\n        set affected = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function Heal_Main takes unit caster, integer level, real duration returns nothing \r\n        local group g = CreateGroup()\r\n        local unit n\r\n        local integer heal\r\n        local integer id\r\n        local group affected = DeleteBuffToAffected(caster, false)\r\n    \r\n        set heal = ( HEAL_FIRST_LEVEL + ( HEAL_LEVEL_BONUS * level ) )\r\n        call GroupEnumUnitsInRange( g, GetUnitX( caster ), GetUnitY( caster ), AREA, null )\r\n        loop\r\n            set n = FirstOfGroup(g)\r\n            exitwhen n == null\r\n            if unitst( n, caster, \"ally\" ) then\r\n                call bufallst( caster, n, EFFECT_HEAL, ID_DAMAGE_BUFF, 0, 0, 0, BUFF_HEAL, \"brdwj\", duration )\r\n                call SetUnitAbilityLevel( n, ID_DAMAGE_BUFF, level )\r\n                \r\n                set id = InvokeTimerWithUnit(n, \"barwj\", TICK, true, function BardWJoyCast ) \r\n                call SaveUnitHandle( udg_hash, id, StringHash( \"barwjd\" ), caster ) \r\n                call SaveReal( udg_hash, id, StringHash( \"barwj\" ), heal )\r\n                call GroupAddUnit(affected,n)\r\n            endif\r\n            call GroupRemoveUnit(g,n)\r\n        endloop\r\n        \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set n = null\r\n        set g = null\r\n        set caster = null\r\n        set affected = null\r\n    endfunction\r\n\r\n    private function Heal takes unit caster, integer level, real duration returns nothing\r\n        if Aspects_IsHeroAspectActive( caster, ASPECT_02 ) then\r\n            call Heal_Alternative( caster, level, duration )\r\n        else\r\n            call Heal_Main( caster, level, duration )\r\n        endif\r\n        \r\n        set caster = null\r\n    endfunction\r\n        \r\n    private function Damage_Alternative takes unit caster, integer level, real duration returns nothing \r\n        local group g = CreateGroup()\r\n        local unit n\r\n        local group affected = DeleteBuffToAffected(caster, true)\r\n        \r\n        call GroupEnumUnitsInRange( g, GetUnitX( caster ), GetUnitY( caster ), AREA, null )\r\n        loop\r\n            set n = FirstOfGroup(g)\r\n            exitwhen n == null\r\n            if unitst( n, caster, TARGET_ENEMY )  then\r\n                call UnitStun(caster, n, STUN_DURATION )\r\n\r\n                call bufallst( caster, n, EFFECT_DAMAGE, ID_DAMAGE_REDUCTION_ALTERNATIVE, 0, 0, 0, BUFF_DAMAGE, \"brdws\", duration )\r\n                call SetUnitAbilityLevel( n, ID_DAMAGE_REDUCTION_ALTERNATIVE, level )\r\n                call GroupAddUnit(affected,n)\r\n            endif\r\n            call GroupRemoveUnit(g,n)\r\n        endloop\r\n        \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set n = null\r\n        set g = null\r\n        set caster = null\r\n        set affected = null\r\n    endfunction\r\n    \r\n    private function Damage_Main takes unit caster, integer level, real duration returns nothing \r\n        local integer index = GetUnitUserData(caster)\r\n        local group g = CreateGroup()\r\n        local unit n\r\n        local real damage\r\n        local integer id\r\n        local group affected = DeleteBuffToAffected(caster, true)\r\n        \r\n        set damage = (DAMAGE_FIRST_LEVEL + (DAMAGE_LEVEL_BONUS*level))*GetUnitSpellPower(caster)\r\n        call GroupEnumUnitsInRange( g, GetUnitX( caster ), GetUnitY( caster ), AREA, null )\r\n        loop\r\n            set n = FirstOfGroup(g)\r\n            exitwhen n == null\r\n            if unitst( n, caster, TARGET_ENEMY )  then\r\n                call UnitStun(caster, n, STUN_DURATION )\r\n\r\n                call bufallst( caster, n, EFFECT_DAMAGE, ID_DAMAGE_REDUCTION, 0, 0, 0, BUFF_DAMAGE, \"brdws\", duration )\r\n                call SetUnitAbilityLevel( n, ID_DAMAGE_REDUCTION, level )\r\n                \r\n                set id = InvokeTimerWithUnit( n, \"barw\", TICK, true, function BardWSorrowCast )\r\n                call SaveUnitHandle( udg_hash, id, StringHash( \"barwc\" ), caster )\r\n                call SaveReal( udg_hash, id, StringHash( \"barw\" ), damage )\r\n                call GroupAddUnit(affected,n)\r\n            endif\r\n            call GroupRemoveUnit(g,n)\r\n        endloop\r\n        \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set n = null\r\n        set g = null\r\n        set caster = null\r\n        set affected = null\r\n    endfunction\r\n    \r\n    private function Damage takes unit caster, integer level, real duration returns nothing\r\n\r\n        if Aspects_IsHeroAspectActive( caster, ASPECT_02 ) then\r\n            call Damage_Alternative( caster, level, duration )\r\n        else\r\n            call Damage_Main( caster, level, duration )\r\n        endif\r\n        \r\n        set caster = null\r\n    endfunction\r\n\r\n    function Trig_BardW_Actions takes nothing returns nothing\r\n        local unit hero = GetOrderedUnit()\r\n        local integer lvl = GetUnitAbilityLevel( hero, ID_ABILITY )\r\n        local real duration = timebonus(hero, DURATION)\r\n\r\n        if GetIssuedOrderId() == OrderId(\"immolation\") then\r\n            call Heal(hero, lvl, duration)\r\n        elseif GetIssuedOrderId() == OrderId(\"unimmolation\") and IsUnitHasAbility(hero, ID_ABILITY_BUFF) then\r\n            call Damage(hero, lvl, duration)\r\n        endif\r\n        \r\n        set hero = null\r\n    endfunction\r\n    \r\n\r\n    private function DeleteBuff_Conditions takes nothing returns boolean\r\n        return IsUnitHasAbility( Event_DeleteBuff_Unit, EFFECT_HEAL)\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n        call RemoveEffect( Event_DeleteBuff_Unit, EFFECT_HEAL, BUFF_HEAL )\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_BardW = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_BardW, EVENT_PLAYER_UNIT_ISSUED_ORDER )\r\n        call TriggerAddCondition( gg_trg_BardW, Condition( function Trig_BardW_Conditions ) )\r\n        call TriggerAddAction( gg_trg_BardW, function Trig_BardW_Actions )\r\n        \r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n    endfunction\r\n\r\nendscope",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}