{
  "Id": 50333176,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "globals\r\n\tframehandle array mephbut\r\n    framehandle array mephicon\r\n    framehandle array mephnum\r\n    framehandle mephuse\r\n    \r\n    constant real MEPHISTAR_E_BLOOD_DURATION = 20\r\n    \r\n    constant real MEPHISTAR_E_MECH_DURATION = 20\r\n    \r\n    constant real MEPHISTAR_E_MOON_DAMAGE = 225\r\n    constant real MEPHISTAR_E_MOON_AREA = 400\r\n    \r\n    constant integer MEPHISTAR_E_NATURE_TRIGGERS = 4\r\n    \r\n    constant real MEPHISTAR_E_RING_DURATION = 20\r\n    \r\n    constant real MEPHISTAR_E_WEAPON_DURATION = 5\r\nendglobals\r\n\r\nfunction MephistarEFrameGeneral takes integer number returns nothing\r\n    set udg_MephistarUse[number] = udg_MephistarUse[number] - 1\r\n    call BlzFrameSetText( mephnum[number], I2S(udg_MephistarUse[number]) )\r\n    if udg_MephistarUse[number] <= 0 then\r\n        call BlzFrameSetTexture( mephicon[number], \"ReplaceableTextures\\\\CommandButtons\\\\BTNCancel.blp\", 0, true )\r\n    endif\r\nendfunction\r\n\r\nfunction MephistarEAlchemy takes nothing returns nothing\r\n    local integer i\r\n    \r\n    call MephistarEFrameGeneral(1)\r\n    \r\n    set i = 1\r\n    loop\r\n        exitwhen i > PLAYERS_LIMIT\r\n        if unitst( udg_hero[i], udg_Mephistar, \"ally\" ) then \r\n            set udg_Caster = udg_hero[i]\r\n            set udg_RandomLogic = true\r\n            call TriggerExecute( udg_DB_Trigger_Pot[GetRandomInt( 1, udg_Database_NumberItems[9] )] )\r\n        endif\r\n        set i = i + 1\r\n    endloop\r\nendfunction\r\n\r\nfunction MephistarEBlood takes nothing returns nothing\r\n    local integer i\r\n    local real t\r\n    \r\n    call MephistarEFrameGeneral(2)\r\n    \r\n    set i = 1\r\n    loop\r\n        exitwhen i > PLAYERS_LIMIT\r\n        if unitst( udg_hero[i], udg_Mephistar, \"ally\" ) then \r\n            set t = timebonus(udg_Mephistar, MEPHISTAR_E_BLOOD_DURATION)\r\n            call DestroyEffect( AddSpecialEffect( \"Objects\\\\Spawnmodels\\\\Orc\\\\OrcSmallDeathExplode\\\\OrcSmallDeathExplode.mdl\", GetUnitX( udg_hero[i] ), GetUnitY( udg_hero[i] ) ) )\r\n            call bufst( udg_Mephistar, udg_hero[i], 'A145', 'B08J', \"mephb\", t )\r\n            call effst( udg_Mephistar, udg_hero[i], null, 1, t )\r\n        endif\r\n        set i = i + 1\r\n    endloop\r\nendfunction\r\n\r\nfunction MephistarECrystal takes nothing returns nothing\r\n    local integer i\r\n    \r\n    call MephistarEFrameGeneral(3)\r\n    \r\n    set i = 1\r\n    loop\r\n        exitwhen i > PLAYERS_LIMIT\r\n        if unitst( udg_hero[i], udg_Mephistar, \"ally\" ) then \r\n            call UnitReduceCooldownPercent( udg_hero[i], 0.4 )\r\n            call DestroyEffect( AddSpecialEffect(\"Abilities\\\\Spells\\\\Items\\\\AIil\\\\AIilTarget.mdl\", GetUnitX(udg_hero[i]), GetUnitY(udg_hero[i]) ) )\r\n        endif\r\n        set i = i + 1\r\n    endloop\r\nendfunction\r\n\r\nfunction MephistarEMech takes nothing returns nothing\r\n    local integer i\r\n    local real t\r\n    \r\n    call MephistarEFrameGeneral(4)\r\n    \r\n    set i = 1\r\n    loop\r\n        exitwhen i > PLAYERS_LIMIT\r\n        if unitst( udg_hero[i], udg_Mephistar, \"ally\" ) then \r\n            set t = timebonus(udg_Mephistar, MEPHISTAR_E_MECH_DURATION)\r\n            call DestroyEffect( AddSpecialEffect( \"Abilities\\\\Spells\\\\Orc\\\\FeralSpirit\\\\feralspirittarget.mdl\", GetUnitX( udg_hero[i] ), GetUnitY( udg_hero[i] ) ) )\r\n            call bufst( udg_Mephistar, udg_hero[i], 'A146', 'B08K', \"mephm\", t )\r\n            call effst( udg_Mephistar, udg_hero[i], null, 1, t )\r\n        endif\r\n        set i = i + 1\r\n    endloop\r\nendfunction\r\n\r\nfunction MephistarEMoon takes nothing returns nothing\r\n    local integer i\r\n    \r\n    call MephistarEFrameGeneral(5)\r\n    \r\n    set i = 1\r\n    loop\r\n        exitwhen i > PLAYERS_LIMIT\r\n        if unitst( udg_hero[i], udg_Mephistar, \"ally\" ) then \r\n            call GroupAoE( udg_Mephistar, null, GetUnitX( udg_hero[i] ), GetUnitY( udg_hero[i] ), MEPHISTAR_E_MOON_DAMAGE, MEPHISTAR_E_MOON_AREA, \"enemy\", \"war3mapImported\\\\ArcaneExplosion.mdx\", null )\r\n        endif\r\n        set i = i + 1\r\n    endloop\r\nendfunction\r\n\r\nfunction MephistarENature takes nothing returns nothing\r\n    local integer i\r\n    local unit target\r\n    \r\n    call MephistarEFrameGeneral(6)\r\n    \r\n    set i = 1\r\n    loop\r\n        exitwhen i > MEPHISTAR_E_NATURE_TRIGGERS\r\n        set target = HeroLessHP(udg_Mephistar)\r\n        if target != null then\r\n            call healst( udg_Mephistar, target, GetUnitState( target, UNIT_STATE_MAX_LIFE) * 0.15 )\r\n            call manast( udg_Mephistar, target, GetUnitState( target, UNIT_STATE_MAX_MANA) * 0.15 )\r\n            set target = null\r\n        endif\r\n        set i = i + 1\r\n    endloop\r\n    \r\n    set target = null\r\nendfunction\r\n\r\nfunction MephistarERing takes nothing returns nothing\r\n    local integer i\r\n    local real t\r\n    \r\n    call MephistarEFrameGeneral(7)\r\n    \r\n    set i = 1\r\n    loop\r\n        exitwhen i > PLAYERS_LIMIT\r\n        if unitst( udg_hero[i], udg_Mephistar, \"ally\" ) then \r\n            set t = timebonus(udg_Mephistar, MEPHISTAR_E_RING_DURATION)\r\n            call bufst( udg_Mephistar, udg_hero[i], 'A147', 'B08L', \"mephr\", t )\r\n            call effst( udg_Mephistar, udg_hero[i], null, 1, t )\r\n        endif\r\n        set i = i + 1\r\n    endloop\r\nendfunction\r\n\r\nfunction MephistarERune takes nothing returns nothing\r\n    local integer i\r\n    local integer runeLimit\r\n    \r\n    if udg_fightmod[3] then\r\n        set runeLimit = Arena_Runes_NoDuel_Count\r\n    else\r\n        set runeLimit = Arena_Runes_Count\r\n    endif\r\n    \r\n    call MephistarEFrameGeneral(8)\r\n    \r\n    set i = 1\r\n    loop\r\n        exitwhen i > PLAYERS_LIMIT\r\n        if unitst( udg_hero[i], udg_Mephistar, \"ally\" ) then \r\n            set bj_lastCreatedItem = CreateItem(Arena_Runes[GetRandomInt(1, runeLimit)], GetUnitX( udg_hero[i] ) + GetRandomReal( -300, 300 ), GetUnitY( udg_hero[i] ) + GetRandomReal( -300, 300 ) )\r\n            call DestroyEffect( AddSpecialEffect( \"Abilities\\\\Spells\\\\Orc\\\\FeralSpirit\\\\feralspirittarget.mdl\", GetItemX( bj_lastCreatedItem ), GetItemY( bj_lastCreatedItem ) ) )\r\n        endif\r\n        set i = i + 1\r\n    endloop\r\nendfunction\r\n\r\nfunction MephistarEWeapon takes nothing returns nothing\r\n    local integer i\r\n    local real t\r\n    \r\n    call MephistarEFrameGeneral(9)\r\n    \r\n    set i = 1\r\n    loop\r\n        exitwhen i > PLAYERS_LIMIT\r\n        if unitst( udg_hero[i], udg_Mephistar, \"ally\" ) then \r\n            set t = timebonus(udg_Mephistar, MEPHISTAR_E_WEAPON_DURATION)\r\n            call bufst( udg_Mephistar, udg_hero[i], 'A148', 'B08M', \"mephw\", t )\r\n            call effst( udg_Mephistar, udg_hero[i], null, 1, t )\r\n        endif\r\n        set i = i + 1\r\n    endloop\r\nendfunction\r\n\r\nfunction MephistarEFrameUse takes nothing returns nothing\r\n    local unit u = udg_Mephistar\r\n    local integer unitId = GetUnitUserData(u)\r\n    local boolean exit\r\n    \r\n    if GetLocalPlayer() == GetTriggerPlayer() then\r\n        call BlzFrameSetVisible( BlzGetTriggerFrame(),false)\r\n\t\tcall BlzFrameSetVisible( BlzGetTriggerFrame(),true)\r\n\tendif\r\n\r\n    if GetUnitState( u, UNIT_STATE_LIFE) > 0.405 and udg_combatlogic[unitId] then\r\n        //При оптимизации стоит учитывать, что позиции наборов и наборов Мефистара отличаются!\r\n        if mephbut[1] == BlzGetTriggerFrame() and udg_Set_Alchemy_Number[unitId] > 0 and udg_MephistarUse[1] > 0 then\r\n            call MephistarEAlchemy()\r\n        elseif mephbut[2] == BlzGetTriggerFrame() and udg_Set_Blood_Number[unitId] > 0 and udg_MephistarUse[2] > 0 then\r\n            call MephistarEBlood()\r\n        elseif mephbut[3] == BlzGetTriggerFrame() and udg_Set_Cristall_Number[unitId] > 0 and udg_MephistarUse[3] > 0 then\r\n            call MephistarECrystal()\r\n        elseif mephbut[4] == BlzGetTriggerFrame() and SetCount_GetPieces(u, SET_MECH) > 0 and udg_MephistarUse[4] > 0 then\r\n            call MephistarEMech()\r\n        elseif mephbut[5] == BlzGetTriggerFrame() and udg_Set_Moon_Number[unitId] > 0 and udg_MephistarUse[5] > 0 then\r\n            call MephistarEMoon()\r\n        elseif mephbut[6] == BlzGetTriggerFrame() and udg_Set_Nature_Number[unitId] > 0 and udg_MephistarUse[6] > 0 then\r\n            call MephistarENature()\r\n        elseif mephbut[7] == BlzGetTriggerFrame() and udg_Set_Ring_Number[unitId] > 0 and udg_MephistarUse[7] > 0 then\r\n            call MephistarERing()\r\n        elseif mephbut[8] == BlzGetTriggerFrame() and udg_Set_Rune_Number[unitId] > 0 and udg_MephistarUse[8] > 0 then\r\n            call MephistarERune()\r\n        elseif mephbut[9] == BlzGetTriggerFrame() and udg_Set_Weapon_Number[unitId] > 0 and udg_MephistarUse[9] > 0 then\r\n            call MephistarEWeapon()\r\n        endif\r\n    endif\r\nendfunction\r\n\r\nfunction Trig_MephistarEFrame_Actions takes nothing returns nothing\r\n    local trigger trig\r\n    local integer i\r\n\r\n    set mephuse = BlzCreateFrameByType(\"BACKDROP\", \"\", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI,0), \"StandartFrameTemplate\", 0)\r\n    call BlzFrameSetVisible( mephuse, false )\r\n    call BlzFrameSetLevel( mephuse, -2 )\r\n\r\n    set i = 1\r\n    loop\r\n        exitwhen i > udg_DB_SoulContract_SetNum\r\n        set mephicon[i] = BlzCreateFrameByType(\"BACKDROP\", \"\",mephuse, \"StandartFrameTemplate\", 0)\r\n        call BlzFrameSetSize( mephicon[i], 0.02, 0.02 )\r\n        call BlzFrameSetAbsPoint(mephicon[i], FRAMEPOINT_CENTER, 0.02, 0.15+(0.02*i))\r\n        call BlzFrameSetTexture( mephicon[i], \"ReplaceableTextures\\\\CommandButtons\\\\BTNCancel.blp\", 0, true )\r\n        \r\n        set mephnum[i] = BlzCreateFrameByType(\"TEXT\", \"\", mephuse, \"StandartFrameTemplate\", 0)\r\n        call BlzFrameSetSize( mephnum[i], 0.01, 0.01 )\r\n        call BlzFrameSetPoint(mephnum[i], FRAMEPOINT_BOTTOMLEFT, mephicon[i], FRAMEPOINT_BOTTOMLEFT, 0.001,0.001) \r\n        call BlzFrameSetText( mephnum[i], \"0\" )\r\n        \r\n        set mephbut[i] = BlzCreateFrameByType(\"GLUEBUTTON\", \"\", mephuse, \"ScoreScreenTabButtonTemplate\", 0)\r\n        call BlzFrameSetSize( mephbut[i], 0.02, 0.02 )\r\n        call BlzFrameSetPoint( mephbut[i], FRAMEPOINT_CENTER, mephicon[i], FRAMEPOINT_CENTER, 0,0)\r\n        \r\n        set trig = CreateTrigger()\r\n        call BlzTriggerRegisterFrameEvent(trig, mephbut[i], FRAMEEVENT_CONTROL_CLICK)\r\n        call TriggerAddAction(trig, function MephistarEFrameUse)\r\n        \r\n        call SetStableTool( mephbut[i], BlzGetAbilityTooltip(udg_DB_SoulContract_Set[i], 0), BlzGetAbilityExtendedTooltip(udg_DB_SoulContract_Set[i], 0) )\r\n        set i = i + 1\r\n    endloop\r\n    \r\n    set trig = null\r\nendfunction\r\n\r\n//===========================================================================\r\nfunction InitTrig_MephistarEFrame takes nothing returns nothing\r\n    set gg_trg_MephistarEFrame = CreateTrigger(  )\r\n    call TriggerRegisterTimerExpireEvent( gg_trg_MephistarEFrame, udg_StartTimer )\r\n    call TriggerAddAction( gg_trg_MephistarEFrame, function Trig_MephistarEFrame_Actions )\r\nendfunction",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}