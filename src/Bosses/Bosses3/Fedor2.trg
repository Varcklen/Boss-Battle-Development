{
  "Id": 50333459,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope Fedor2 initializer init\r\n\r\n    globals\r\n        private constant integer ID_BOSS = 'h00B'\r\n        private constant integer ID_TRAIN = 'h00C'\r\n        private constant integer ID_INVUL = 'Avul'\r\n        \r\n        private constant integer HEALTH_CHECK = 33\r\n        private constant integer COOLDOWN = 7\r\n        private constant integer DELAY = 3\r\n        private constant real TICK = 0.04\r\n        private constant integer FLIGHT_LENGTH = 24\r\n        private constant integer DAMAGE = 40\r\n        private constant integer SPEED = 42\r\n        private constant integer AREA = 128\r\n        private constant integer WAVES = 3\r\n        private constant integer START_ANGLE = -90\r\n        private constant integer ANGLE_DIFFERENCE = 45\r\n        \r\n        private constant string WAVE_ANIMATION = \"Abilities\\\\Spells\\\\Orc\\\\Shockwave\\\\ShockwaveMissile.mdl\"\r\n        private constant string TELEPORT_ANIMATION = \"Abilities\\\\Spells\\\\Human\\\\MassTeleport\\\\MassTeleportCaster.mdl\"\r\n    endglobals\r\n\r\n    function Trig_Fedor2_Conditions takes nothing returns boolean\r\n        return GetUnitTypeId(udg_DamageEventTarget) == ID_BOSS and GetUnitLifePercent(udg_DamageEventTarget) <= HEALTH_CHECK\r\n    endfunction\r\n    \r\n    private function DealDamage takes effect wave, group nodmg, unit boss returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        \r\n        call GroupEnumUnitsInRange( g, BlzGetLocalSpecialEffectX( wave ), BlzGetLocalSpecialEffectY( wave ), AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, boss, \"enemy\" ) and not( IsUnitInGroup( u, nodmg ) ) then\r\n                call UnitTakeDamage(boss, u, DAMAGE, DAMAGE_TYPE_MAGIC)\r\n                call GroupAddUnit( nodmg, u )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n        \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set wave = null\r\n        set nodmg = null\r\n        set boss = null\r\n    endfunction\r\n\r\n    private function WaveUse takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local integer counter = LoadInteger( udg_hash, id, StringHash( \"bsfdw\" ) ) + 1\r\n        local effect wave = LoadEffectHandle( udg_hash, id, StringHash( \"bsfdw\" ) )\r\n        local unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"bsfdwb\" ) )\r\n        local group nodmg = LoadGroupHandle( udg_hash, id, StringHash( \"bsfdwg\" ) )\r\n        local real yaw = LoadReal( udg_hash, id, StringHash( \"bsfdw\" ) )\r\n        local Math_point newPoint = 0\r\n\r\n        if counter >= FLIGHT_LENGTH or wave == null then\r\n            call DestroyEffect( wave )\r\n            call GroupClear( nodmg )\r\n            call DestroyGroup( nodmg )\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        else\r\n            set newPoint = GetMovedPoint( wave, yaw, SPEED )\r\n            call BlzSetSpecialEffectPosition( wave, newPoint.x, newPoint.y, BlzGetLocalSpecialEffectZ(wave) )\r\n            call DealDamage( wave, nodmg, boss )\r\n            call SaveInteger( udg_hash, id, StringHash( \"bsfdw\" ), counter )\r\n        endif\r\n\r\n        call newPoint.destroy()\r\n        set wave = null\r\n        set boss = null\r\n        set nodmg = null\r\n    endfunction\r\n    \r\n    private function CreateWave takes unit boss, unit train, real angle returns nothing\r\n        local effect wave\r\n        local real yaw\r\n        local integer id\r\n    \r\n        set wave = AddSpecialEffect( WAVE_ANIMATION, GetUnitX(train), GetUnitY(train))\r\n        set yaw = Deg2Rad(angle)\r\n        call BlzSetSpecialEffectYaw( wave, yaw )\r\n        \r\n        set id = InvokeTimerWithEffect( wave, \"bsfdw\", TICK, true, function WaveUse )\r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"bsfdwb\" ), boss )\r\n        //call SaveUnitHandle( udg_hash, id, StringHash( \"bsfdwtr\" ), train )\r\n        call SaveReal( udg_hash, id, StringHash( \"bsfdw\" ), yaw )\r\n        call SaveGroupHandle( udg_hash, id, StringHash( \"bsfdwg\" ), CreateGroup() )\r\n    \r\n        set wave = null\r\n        set boss = null\r\n    endfunction\r\n\r\n    function FedorTrain takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local integer i\r\n        local unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"bsfd2\" ) )\r\n        local unit train = LoadUnitHandle( udg_hash, id, StringHash( \"bsfd2tr\" ) )\r\n        \r\n        if IsUnitDead(train) or udg_fightmod[0] == false then\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        else\r\n            set i = 1\r\n            loop\r\n                exitwhen i > WAVES\r\n                call CreateWave( boss, train, GetUnitFacing( train ) + START_ANGLE + ( i * ANGLE_DIFFERENCE ) )\r\n                set i = i + 1\r\n            endloop\r\n            call aggro( train )\r\n        endif\r\n        \r\n        set boss = null\r\n        set train = null\r\n    endfunction\r\n\r\n    function FedorRepeat takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"bsfd1\" ) )\r\n        local unit train = LoadUnitHandle( udg_hash, id, StringHash( \"bsfd1tr\" ) )\r\n        local integer id1\r\n        \r\n        if IsUnitDead(train) or IsUnitDead(boss) or udg_fightmod[0] == false then\r\n            call UnitRemoveAbility( boss, ID_INVUL)\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        elseif IsUnitInTransport( boss, train ) then\r\n            //if IsUnitAlive(boss) and udg_fightmod[0] then\r\n            call SetUnitPathing( train, true )\r\n            call UnitRemoveAbility( boss, ID_INVUL)\r\n            call aggro( train )\r\n            \r\n            set id1 = InvokeTimerWithUnit(boss, \"bsfd2\", bosscast(COOLDOWN), true, function FedorTrain )\r\n            call SaveUnitHandle( udg_hash, id1, StringHash( \"bsfd2tr\" ), train )\r\n            //endif\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() ) \r\n        else\r\n            call IssueTargetOrder( boss, \"board\", train )\r\n        endif\r\n        \r\n        set boss = null\r\n        set train = null\r\n    endfunction\r\n\r\n    function FedorCast takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"bsfd\" ) )\r\n        local unit train = LoadUnitHandle( udg_hash, id, StringHash( \"bsfdtr\" ) )\r\n        local integer id1 = GetHandleId( boss )    \r\n        \r\n        call SetDestructableAnimation(udg_DEST_GATE, \"stand\")\r\n        if IsUnitAlive(boss) and udg_fightmod[0] then\r\n            call PauseUnit( boss, false )\r\n            call IssueTargetOrder( boss, \"board\", train )\r\n\r\n            set id1 = InvokeTimerWithUnit(boss, \"bsfd1\", 0.2, true, function FedorRepeat )\r\n            call SaveUnitHandle( udg_hash, id1, StringHash( \"bsfd1tr\" ), train )\r\n        endif\r\n        call FlushChildHashtable( udg_hash, id )\r\n        \r\n        set boss = null\r\n        set train = null\r\n    endfunction\r\n\r\n    function Trig_Fedor2_Actions takes nothing returns nothing\r\n        local unit boss = udg_DamageEventTarget\r\n        local unit train\r\n        local integer id \r\n        \r\n        call DisableTrigger( GetTriggeringTrigger() )\r\n        if udg_Boss_Rect == gg_rct_ArenaBoss then\r\n            call SetDestructableAnimation(udg_DEST_GATE, \"death alternate\")\r\n        endif\r\n        \r\n        call IssueImmediateOrder( boss, \"stop\" )\r\n        call PauseUnit( boss, true)\r\n        call UnitAddAbility( boss, ID_INVUL )\r\n        call SetUnitPosition( boss, GetRectCenterX(udg_Boss_Rect), GetRectCenterY(udg_Boss_Rect) + 600 )\r\n        call PlaySpecialEffect(TELEPORT_ANIMATION, boss)\r\n        \r\n        set train = CreateUnit( GetOwningPlayer( boss ), ID_TRAIN, GetRectCenterX(udg_Boss_Rect) - 2000, GetRectCenterY(udg_Boss_Rect) + 600, 0 )\r\n        call IssuePointOrder( train, \"move\", GetUnitX( boss ), GetUnitY( boss ) )\r\n        call SetUnitPathing( train, false )\r\n        \r\n        set id = InvokeTimerWithUnit(boss, \"bsfd\", DELAY, false, function FedorCast )\r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"bsfdtr\" ), train )\r\n        \r\n        set train = null\r\n        set boss = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_Fedor2 = CreateEventTrigger( \"udg_AfterDamageEvent\", function Trig_Fedor2_Actions, function Trig_Fedor2_Conditions )\r\n        call DisableTrigger( gg_trg_Fedor2 )\r\n    endfunction\r\n\r\nendscope",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}